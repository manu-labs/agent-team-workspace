import { useRef, useEffect, useCallback } from 'react';
import { useGameStore } from '../stores/gameStore';
import { createGame } from '../game/engine';
import { renderMiniPiece } from '../game/renderer';
import GameCanvas from '../components/GameCanvas';
import GameOverlay from '../components/GameOverlay';
import TouchControls from '../components/TouchControls';

export default function GamePage() {
  const gameRef = useRef(null);
  const { status, score, level, linesCleared, durationSeconds } = useGameStore();

  // Create game instance once
  if (!gameRef.current) {
    gameRef.current = createGame();
  }
  const game = gameRef.current;

  // Keyboard controls
  const handleKeyDown = useCallback((e) => {
    const state = game.getState();

    if (e.key === 'p' || e.key === 'P') {
      e.preventDefault();
      if (state.status === 'playing') game.pauseGame();
      else if (state.status === 'paused') game.resumeGame();
      return;
    }

    if (state.status !== 'playing') return;

    switch (e.key) {
      case 'ArrowLeft':
        e.preventDefault();
        game.move('left');
        break;
      case 'ArrowRight':
        e.preventDefault();
        game.move('right');
        break;
      case 'ArrowDown':
        e.preventDefault();
        game.move('down');
        break;
      case 'ArrowUp':
        e.preventDefault();
        game.rotate('cw');
        break;
      case ' ':
        e.preventDefault();
        game.drop();
        break;
      case 'c':
      case 'C':
        e.preventDefault();
        game.hold();
        break;
      case 'Shift':
        e.preventDefault();
        game.rotate('ccw');
        break;
    }
  }, [game]);

  useEffect(() => {
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [handleKeyDown]);

  return (
    <div className="h-full flex items-center justify-center p-2 md:p-4 relative" style={{ zIndex: 1 }}>
      <div className="flex gap-3 h-full max-h-[calc(100vh-60px)] items-center">
        {/* Left: Hold + Next */}
        <div className="hidden md:flex flex-col gap-3 w-36 shrink-0">
          <SidePanel title="Hold" game={game} type="hold" />
          <SidePanel title="Next" game={game} type="next" />
        </div>

        {/* Center: Game board */}
        <div className="relative aspect-[1/2] h-full max-h-[80vh]">
          <GameCanvas game={game} />
          <GameOverlay
            status={status}
            game={game}
            score={score}
            level={level}
            lines={linesCleared}
            duration={durationSeconds}
          />
        </div>

        {/* Right: Stats */}
        <div className="hidden md:flex flex-col gap-3 w-36 shrink-0">
          <StatsPanel score={score} level={level} lines={linesCleared} duration={durationSeconds} />
        </div>
      </div>

      {/* Mobile stats bar */}
      {(status === 'playing' || status === 'paused') && (
        <div className="md:hidden fixed top-14 left-0 right-0 flex justify-center z-20 px-4">
          <div className="glass-panel px-3 py-1 flex gap-4 text-xs font-mono">
            <span className="text-neon-yellow">{score.toLocaleString()}</span>
            <span className="text-white/20">|</span>
            <span className="text-neon-cyan">L{level}</span>
            <span className="text-white/20">|</span>
            <span className="text-neon-green">{linesCleared} lines</span>
          </div>
        </div>
      )}

      <TouchControls game={game} status={status} />
    </div>
  );
}

function SidePanel({ title, game, type }) {
  const canvasRef = useRef(null);
  const height = type === 'hold' ? 50 : 150;

  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas || !game) return;
    let animId;

    function draw() {
      const ctx = canvas.getContext('2d');
      const state = game.getState();
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (type === 'hold' && state.holdType) {
        renderMiniPiece(ctx, state.holdType, canvas.width / 2, canvas.height / 2, 14);
      } else if (type === 'next') {
        const pieces = state.nextPieces || [];
        const spacing = canvas.height / 3;
        pieces.slice(0, 3).forEach((t, i) => {
          renderMiniPiece(ctx, t, canvas.width / 2, spacing * i + spacing / 2, 12);
        });
      }
      animId = requestAnimationFrame(draw);
    }

    draw();
    return () => { if (animId) cancelAnimationFrame(animId); };
  }, [game, type]);

  return (
    <div className="glass-panel p-3">
      <h3 className="text-[10px] font-display uppercase tracking-widest text-white/30 mb-2">{title}</h3>
      <canvas ref={canvasRef} width={100} height={height} className="w-full" />
    </div>
  );
}

function StatsPanel({ score, level, lines, duration }) {
  const mins = Math.floor(duration / 60);
  const secs = duration % 60;
  const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;

  return (
    <div className="glass-panel p-3 space-y-3">
      <StatRow label="Score" value={score.toLocaleString()} color="text-neon-yellow" />
      <StatRow label="Level" value={level} color="text-neon-cyan" />
      <StatRow label="Lines" value={lines} color="text-neon-green" />
      <StatRow label="Time" value={timeStr} color="text-white/60" />
    </div>
  );
}

function StatRow({ label, value, color }) {
  return (
    <div>
      <div className="text-[10px] font-display uppercase tracking-widest text-white/30">{label}</div>
      <div className={`text-lg font-mono font-bold ${color}`}>{value}</div>
    </div>
  );
}

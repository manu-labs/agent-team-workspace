/**
 * Canvas rendering functions for Space Tetris.
 * Pure drawing — no React, no state management.
 */

import { COLS, ROWS, COLORS } from './engine';

const GRID_COLOR = 'rgba(100, 100, 255, 0.08)';
const GRID_BORDER_COLOR = 'rgba(100, 130, 255, 0.2)';
const GHOST_ALPHA = 0.2;
const GLOW_BLUR = 8;

/**
 * Calculate cell size to fit the canvas dimensions.
 */
export function cellSize(canvas) {
  return Math.floor(Math.min(canvas.width / COLS, canvas.height / ROWS));
}

/**
 * Render the full game board to the canvas.
 * @param {CanvasRenderingContext2D} ctx
 * @param {object} state — from game.getState()
 * @param {number} size — cell size in px
 */
export function renderBoard(ctx, state, size) {
  const w = COLS * size;
  const h = ROWS * size;
  const offsetX = Math.floor((ctx.canvas.width - w) / 2);
  const offsetY = Math.floor((ctx.canvas.height - h) / 2);

  ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

  // Board background
  ctx.fillStyle = 'rgba(5, 5, 30, 0.85)';
  ctx.fillRect(offsetX, offsetY, w, h);

  // Grid lines
  ctx.strokeStyle = GRID_COLOR;
  ctx.lineWidth = 0.5;
  for (let r = 0; r <= ROWS; r++) {
    ctx.beginPath();
    ctx.moveTo(offsetX, offsetY + r * size);
    ctx.lineTo(offsetX + w, offsetY + r * size);
    ctx.stroke();
  }
  for (let c = 0; c <= COLS; c++) {
    ctx.beginPath();
    ctx.moveTo(offsetX + c * size, offsetY);
    ctx.lineTo(offsetX + c * size, offsetY + h);
    ctx.stroke();
  }

  // Board border
  ctx.strokeStyle = GRID_BORDER_COLOR;
  ctx.lineWidth = 2;
  ctx.strokeRect(offsetX, offsetY, w, h);

  // Placed blocks
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      if (state.board[r][c]) {
        drawCell(ctx, offsetX + c * size, offsetY + r * size, size, state.board[r][c]);
      }
    }
  }

  if (!state.current) return;

  const piece = state.current;
  const pieceDef = getPieceRotation(piece.type, piece.rotation);

  // Ghost piece
  if (state.ghostRow !== null && state.ghostRow !== piece.row) {
    for (const [dr, dc] of pieceDef) {
      const gr = state.ghostRow + dr;
      const gc = piece.col + dc;
      if (gr >= 0 && gr < ROWS) {
        drawCell(ctx, offsetX + gc * size, offsetY + gr * size, size, COLORS[piece.type], GHOST_ALPHA);
      }
    }
  }

  // Active piece
  for (const [dr, dc] of pieceDef) {
    const pr = piece.row + dr;
    const pc = piece.col + dc;
    if (pr >= 0 && pr < ROWS) {
      drawCell(ctx, offsetX + pc * size, offsetY + pr * size, size, COLORS[piece.type]);
    }
  }
}

/**
 * Draw a single colored cell with neon glow effect.
 */
function drawCell(ctx, x, y, size, color, alpha = 1) {
  const padding = 1;
  const inner = size - padding * 2;

  ctx.save();
  ctx.globalAlpha = alpha;

  // Glow
  if (alpha === 1) {
    ctx.shadowColor = color;
    ctx.shadowBlur = GLOW_BLUR;
  }

  // Fill
  ctx.fillStyle = color;
  ctx.fillRect(x + padding, y + padding, inner, inner);

  // Inner highlight
  ctx.shadowBlur = 0;
  ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
  ctx.fillRect(x + padding, y + padding, inner, 2);
  ctx.fillRect(x + padding, y + padding, 2, inner);

  // Inner shadow
  ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
  ctx.fillRect(x + padding, y + padding + inner - 2, inner, 2);
  ctx.fillRect(x + padding + inner - 2, y + padding, 2, inner);

  ctx.restore();
}

/**
 * Render a mini piece preview (for Next queue and Hold display).
 * @param {CanvasRenderingContext2D} ctx
 * @param {string} type — piece type (I, O, T, etc.)
 * @param {number} cx — center X
 * @param {number} cy — center Y
 * @param {number} miniSize — cell size for preview
 */
export function renderMiniPiece(ctx, type, cx, cy, miniSize) {
  if (!type) return;
  const cells = getPieceRotation(type, 0);

  // Center the piece
  let minR = Infinity, maxR = -Infinity, minC = Infinity, maxC = -Infinity;
  for (const [r, c] of cells) {
    minR = Math.min(minR, r);
    maxR = Math.max(maxR, r);
    minC = Math.min(minC, c);
    maxC = Math.max(maxC, c);
  }
  const pieceW = (maxC - minC + 1) * miniSize;
  const pieceH = (maxR - minR + 1) * miniSize;
  const startX = cx - pieceW / 2;
  const startY = cy - pieceH / 2;

  for (const [r, c] of cells) {
    drawCell(
      ctx,
      startX + (c - minC) * miniSize,
      startY + (r - minR) * miniSize,
      miniSize,
      COLORS[type]
    );
  }
}

/**
 * Get rotation offsets for a piece type.
 * Mirrors the PIECES definition from engine.js.
 */
const PIECE_ROTATIONS = {
  I: [
    [[1,0],[1,1],[1,2],[1,3]], [[0,2],[1,2],[2,2],[3,2]],
    [[2,0],[2,1],[2,2],[2,3]], [[0,1],[1,1],[2,1],[3,1]],
  ],
  O: [
    [[0,1],[0,2],[1,1],[1,2]], [[0,1],[0,2],[1,1],[1,2]],
    [[0,1],[0,2],[1,1],[1,2]], [[0,1],[0,2],[1,1],[1,2]],
  ],
  T: [
    [[0,1],[1,0],[1,1],[1,2]], [[0,1],[1,1],[1,2],[2,1]],
    [[1,0],[1,1],[1,2],[2,1]], [[0,1],[1,0],[1,1],[2,1]],
  ],
  S: [
    [[0,1],[0,2],[1,0],[1,1]], [[0,1],[1,1],[1,2],[2,2]],
    [[1,1],[1,2],[2,0],[2,1]], [[0,0],[1,0],[1,1],[2,1]],
  ],
  Z: [
    [[0,0],[0,1],[1,1],[1,2]], [[0,2],[1,1],[1,2],[2,1]],
    [[1,0],[1,1],[2,1],[2,2]], [[0,1],[1,0],[1,1],[2,0]],
  ],
  J: [
    [[0,0],[1,0],[1,1],[1,2]], [[0,1],[0,2],[1,1],[2,1]],
    [[1,0],[1,1],[1,2],[2,2]], [[0,1],[1,1],[2,0],[2,1]],
  ],
  L: [
    [[0,2],[1,0],[1,1],[1,2]], [[0,1],[1,1],[2,1],[2,2]],
    [[1,0],[1,1],[1,2],[2,0]], [[0,0],[0,1],[1,1],[2,1]],
  ],
};

function getPieceRotation(type, rotation) {
  return PIECE_ROTATIONS[type]?.[rotation] || [];
}

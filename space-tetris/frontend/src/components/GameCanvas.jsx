import { useRef, useEffect, useCallback } from 'react';
import { renderBoard, cellSize } from '../game/renderer';

/**
 * Main game canvas — renders the Tetris board at 60fps.
 * Reads state from game.getState() each frame.
 *
 * @param {{ game: object }} props — game instance from createGame()
 */
export default function GameCanvas({ game }) {
  const canvasRef = useRef(null);
  const rafRef = useRef(null);

  const draw = useCallback(() => {
    const canvas = canvasRef.current;
    if (!canvas || !game) return;

    const ctx = canvas.getContext('2d');
    const state = game.getState();
    const size = cellSize(canvas);
    renderBoard(ctx, state, size);

    rafRef.current = requestAnimationFrame(draw);
  }, [game]);

  // Resize canvas to fill container
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    function resize() {
      const parent = canvas.parentElement;
      const dpr = window.devicePixelRatio || 1;
      canvas.width = parent.clientWidth * dpr;
      canvas.height = parent.clientHeight * dpr;
      canvas.style.width = parent.clientWidth + 'px';
      canvas.style.height = parent.clientHeight + 'px';
      const ctx = canvas.getContext('2d');
      ctx.scale(dpr, dpr);
      // Reset canvas logical size for cellSize calculation
      canvas.width = parent.clientWidth;
      canvas.height = parent.clientHeight;
    }

    resize();
    window.addEventListener('resize', resize);
    return () => window.removeEventListener('resize', resize);
  }, []);

  // Render loop
  useEffect(() => {
    rafRef.current = requestAnimationFrame(draw);
    return () => {
      if (rafRef.current) cancelAnimationFrame(rafRef.current);
    };
  }, [draw]);

  return (
    <canvas
      ref={canvasRef}
      className="w-full h-full block"
    />
  );
}

import { useRef, useEffect, useCallback } from 'react';
import { createGame } from '../game/engine';
import { renderBoard, cellSize } from '../game/renderer';
import { useGameStore } from '../stores/gameStore';

/** Singleton game instance shared across renders. */
let game = null;

export function getGame() {
  if (!game) game = createGame();
  return game;
}

// Key repeat config (ms)
const DAS = 170;   // Delayed Auto Shift
const ARR = 50;    // Auto Repeat Rate

export default function GameCanvas() {
  const canvasRef = useRef(null);
  const rafRef = useRef(null);
  const keysRef = useRef({});
  const repeatRef = useRef({});
  const status = useGameStore((s) => s.status);

  // ── Render loop ──────────────────────────────────────────────────────────
  const draw = useCallback(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const g = getGame();
    const size = cellSize(canvas);
    renderBoard(ctx, g.getState(), size);
    rafRef.current = requestAnimationFrame(draw);
  }, []);

  // Start/stop render loop based on game status
  useEffect(() => {
    if (status === 'playing' || status === 'paused') {
      rafRef.current = requestAnimationFrame(draw);
    }
    return () => {
      if (rafRef.current) cancelAnimationFrame(rafRef.current);
    };
  }, [status, draw]);

  // ── Canvas sizing ────────────────────────────────────────────────────────
  useEffect(() => {
    function resize() {
      const canvas = canvasRef.current;
      if (!canvas) return;
      const parent = canvas.parentElement;
      canvas.width = parent.clientWidth;
      canvas.height = parent.clientHeight;
    }
    resize();
    window.addEventListener('resize', resize);
    return () => window.removeEventListener('resize', resize);
  }, []);

  // ── Keyboard controls ───────────────────────────────────────────────────
  useEffect(() => {
    const g = getGame();

    function handleAction(action) {
      const s = g.getState().status;
      if (s !== 'playing') return;
      switch (action) {
        case 'left':      g.move('left'); break;
        case 'right':     g.move('right'); break;
        case 'down':      g.move('down'); break;
        case 'drop':      g.drop(); break;
        case 'rotateCW':  g.rotate('cw'); break;
        case 'rotateCCW': g.rotate('ccw'); break;
        case 'hold':      g.hold(); break;
      }
    }

    function keyToAction(e) {
      switch (e.code) {
        case 'ArrowLeft':  case 'KeyA': return 'left';
        case 'ArrowRight': case 'KeyD': return 'right';
        case 'ArrowDown':  case 'KeyS': return 'down';
        case 'Space':                    return 'drop';
        case 'ArrowUp':    case 'KeyW': case 'KeyX': return 'rotateCW';
        case 'KeyZ': case 'ControlLeft': case 'ControlRight': return 'rotateCCW';
        case 'KeyC': case 'ShiftLeft': case 'ShiftRight':     return 'hold';
        default: return null;
      }
    }

    function onKeyDown(e) {
      // Pause/unpause
      if (e.code === 'KeyP' || e.code === 'Escape') {
        e.preventDefault();
        const s = g.getState().status;
        if (s === 'playing') g.pauseGame();
        else if (s === 'paused') g.resumeGame();
        return;
      }

      const action = keyToAction(e);
      if (!action) return;
      e.preventDefault();

      if (keysRef.current[action]) return; // already held
      keysRef.current[action] = true;

      handleAction(action);

      // DAS for movement keys
      if (action === 'left' || action === 'right' || action === 'down') {
        const dasTimeout = setTimeout(() => {
          const arrInterval = setInterval(() => {
            if (keysRef.current[action]) handleAction(action);
            else clearInterval(arrInterval);
          }, ARR);
          repeatRef.current[action] = { interval: arrInterval };
        }, DAS);
        repeatRef.current[action] = { timeout: dasTimeout };
      }
    }

    function onKeyUp(e) {
      const action = keyToAction(e);
      if (!action) return;
      keysRef.current[action] = false;

      const rep = repeatRef.current[action];
      if (rep) {
        if (rep.timeout) clearTimeout(rep.timeout);
        if (rep.interval) clearInterval(rep.interval);
        delete repeatRef.current[action];
      }
    }

    window.addEventListener('keydown', onKeyDown);
    window.addEventListener('keyup', onKeyUp);
    return () => {
      window.removeEventListener('keydown', onKeyDown);
      window.removeEventListener('keyup', onKeyUp);
      // Clear all repeats
      Object.values(repeatRef.current).forEach((rep) => {
        if (rep.timeout) clearTimeout(rep.timeout);
        if (rep.interval) clearInterval(rep.interval);
      });
      repeatRef.current = {};
      keysRef.current = {};
    };
  }, []);

  // ── Touch controls ──────────────────────────────────────────────────────
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const g = getGame();

    let touchStartX = 0;
    let touchStartY = 0;
    let touchStartTime = 0;
    const SWIPE_THRESHOLD = 30;

    function onTouchStart(e) {
      e.preventDefault();
      const t = e.touches[0];
      touchStartX = t.clientX;
      touchStartY = t.clientY;
      touchStartTime = Date.now();
    }

    function onTouchEnd(e) {
      e.preventDefault();
      if (g.getState().status !== 'playing') return;
      const t = e.changedTouches[0];
      const dx = t.clientX - touchStartX;
      const dy = t.clientY - touchStartY;
      const dt = Date.now() - touchStartTime;

      if (Math.abs(dx) < SWIPE_THRESHOLD && Math.abs(dy) < SWIPE_THRESHOLD) {
        // Tap — rotate
        if (dt < 200) g.rotate('cw');
        return;
      }

      if (Math.abs(dx) > Math.abs(dy)) {
        // Horizontal swipe
        if (dx > 0) g.move('right');
        else g.move('left');
      } else {
        // Vertical swipe
        if (dy > SWIPE_THRESHOLD * 2) g.drop(); // swipe down = hard drop
        else if (dy > 0) g.move('down');
      }
    }

    canvas.addEventListener('touchstart', onTouchStart, { passive: false });
    canvas.addEventListener('touchend', onTouchEnd, { passive: false });
    return () => {
      canvas.removeEventListener('touchstart', onTouchStart);
      canvas.removeEventListener('touchend', onTouchEnd);
    };
  }, []);

  return (
    <canvas
      ref={canvasRef}
      className="w-full h-full block"
      style={{ touchAction: 'none' }}
    />
  );
}
